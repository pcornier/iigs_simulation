# [cite_start]Apple IIgs Timing and the Fast Processor Interface [cite: 5]
[cite_start]**Daniel Kruszyna** [cite: 6]  
[cite_start]**22 July 2011** [cite: 7]  
[cite_start]**[http://krue.net/](http://krue.net/)** [cite: 8]

***

### [cite_start]OVERVIEW [cite: 10]

[cite_start]The FPI goes by two names, depending on whether it's located in a ROM 1 or ROM 3 machine[cite: 11]. [cite_start]This text uses the term FPI to refer to both variants[cite: 12].
* [cite_start]**FPI**: Fast Processor Interface [cite: 13]
* [cite_start]**CYA**: Control Your Apple (Not according to Urban Dictionary) [cite: 14]

[cite_start]The FPI is the interface between the legacy Apple II bus and the fast IIgs processor and memory[cite: 15]. [cite_start]It has Three Main (Interrelated) Duties[cite: 16]:
1.  [cite_start]Generate PH2, the fast CPU clock [cite: 18]
2.  [cite_start]Interface with fast RAM, ROM, and the slow bus [cite: 20]
3.  [cite_start]Control video RAM and `$I/O$` shadowing [cite: 21]

***

### [cite_start]PH2 GENERATION [cite: 23]

[cite_start]The FPI is clocked by 14M, the same ~14MHz signal available in 8bit Apple IIs[cite: 25]. [cite_start]Sequential outputs of the FPI are loaded on the rising edge of 14M[cite: 26]. [cite_start]All intervals below are in units of 14M ticks (~70ns)[cite: 27].

[cite_start]There are three types of PH2 cycles[cite: 28]. [cite_start]One type, the SYNC cycle, may look slightly different depending on whether the slow bus is about to execute a STRETCH cycle or not[cite: 28].

| Cycle | Low | High | Total |
| :--- | :--- | :--- | :--- |
| [cite_start]**Normal Fast** [cite: 39] | [cite_start]2 [cite: 41] | [cite_start]3 [cite: 42] | [cite_start]5 [cite: 44] |
| [cite_start]**Fast Refresh** [cite: 51] | [cite_start]2 [cite: 52] | [cite_start]8 [cite: 54] | [cite_start]10 [cite: 56] |
| [cite_start]**Sync** [cite: 64] | [cite_start]2 [cite: 66] | [cite_start]12-25 [cite: 67] | [cite_start]14-27 [cite: 68] |
| [cite_start]**Sync Stretch** [cite: 75] | [cite_start]2 [cite: 75] | [cite_start]14-27 [cite: 75] | [cite_start]16-29 [cite: 76] |

[cite_start]In a **NORMAL FAST** cycle, PH2 is running at its fastest rate[cite: 77]. [cite_start]This cycle is used for accesses to fast RAM and ROM, when the system speed is set to FAST[cite: 78]. [cite_start]When accessing ROM, the fast RAM can also be refreshed during this cycle, incurring no speed loss[cite: 79].

[cite_start]In a **FAST REFRESH** cycle, the high phase of PH2 is extended by 5 ticks[cite: 80]. [cite_start]A RAM refresh is performed in the first 5 ticks, followed by the normal access in the second 5 ticks[cite: 81]. [cite_start]This cycle is used for accesses to fast RAM, when the system speed is set to FAST[cite: 82]. [cite_start]When running completely from fast RAM, every 9th PH2 cycle is a FAST REFRESH cycle[cite: 83].

[cite_start]In a **SYNC** cycle, the high phase of PH2 is extended by as many ticks as are necessary to align with a full cycle of PH0[cite: 84]. [cite_start]If the falling edge of PH2 coincides with the falling edge of PH0, then "only" 9 ticks must be added (11 ticks for a STRETCH cycle)[cite: 85]. [cite_start]If the falling edges do not align, then an additional 1 to 13 ticks are added to wait for PH0[cite: 86]. [cite_start]Fast RAM can also be refreshed during this cycle, incurring no speed loss[cite: 87].

***

### [cite_start]PH0 SYNCHRONIZATION [cite: 89]

[cite_start]During a SYNC cycle, the FPI extends PH2 so that it is synchronized to PH0[cite: 91]. [cite_start]However, PH0 is generated by the MEGA II and is not connected to the FPI! [cite: 92] [cite_start]The FPI recreates PH0 internally using 14M and STRETCH, a signal generated by the VGC, or Video Graphics Controller[cite: 93].

[cite_start]The FPI will issue a SYNC cycle in the following circumstances[cite: 94]:
1.  [cite_start]The system speed is set to SLOW[cite: 95].
2.  [cite_start]An enabled Disk II Slot Monitor has detected that a Disk II is currently being accessed[cite: 98].
3.  [cite_start]The system is writing to shadowed video RAM[cite: 99].
4.  [cite_start]The system is reading or writing to `$I/O$` (with a few exceptions)[cite: 101].
5.  [cite_start]The system is accessing any address in banks \$e0 or \$el[cite: 103].

***

### [cite_start]SYSTEM SPEED [cite: 104]

[cite_start]The base system speed is controlled by one bit in the SPEED REGISTER[cite: 105]. [cite_start]The speed can be set to FAST or NORMAL[cite: 106]. [cite_start]In addition to the base system speed, the FPI can keep track of accesses to Disk II hardware in slots 4-7[cite: 107]. [cite_start]The firmware enables this feature for slots in which it detects Disk II firmware at startup[cite: 108]. [cite_start]Specifically, the FPI tracks the `$I/O$` locations which start and stop the drive motor[cite: 109]. [cite_start]If the drive is spinning, then the system speed is forced to NORMAL[cite: 110].

***

### [cite_start]SHADOWING [cite: 112]

[cite_start]In order to keep compatibility with the existing 8bit video modes, all video generation circuitry is located on the slow bus[cite: 114]. [cite_start]SHADOWING improves overall system speed by minimizing the number of accesses to slow RAM[cite: 115]. [cite_start]The MEGA II MAIN and AUX banks, which contain the video buffers, are seen by the CPU at banks \$e0 and \$el[cite: 116]. [cite_start]The real MAIN and AUX banks are located at banks \$00 and \$01[cite: 117]. [cite_start]When a SHADOWED write occurs, the system is slowed to NORMAL speed, and BOTH the fast RAM and MEGA II RAM are written to[cite: 118]. [cite_start]All reads to SHADOWED memory occur at FAST system speed, since the data can be read directly from fast RAM[cite: 119]. [cite_start]SHADOWING can be enabled independently for most video buffer address ranges[cite: 120].

[cite_start]As a consequence of this arrangement of RAM banks, the FPI must also SHADOW accesses to `$I/O$` locations[cite: 121]. [cite_start]8bit applications expect to access `$I/O$` in banks \$00 and \$01[cite: 122]. [cite_start]The bit which enables `$I/O$` SHADOWING also enables LANGUAGE CARD behavior in SHADOWED fast RAM banks[cite: 123]. [cite_start]As a consequence, the FPI must implement all LANGUAGE CARD and AUX RAM softswitches[cite: 124].

[cite_start]Both reads and writes to `$I/O$` locations are SHADOWED, with the following exceptions[cite: 125]:
1.  [cite_start]Registers that exist only in the FPI are not SHADOWED at all[cite: 128]. [cite_start]Both reads and write occur at FAST system speed[cite: 129]. [cite_start]These include SHADOW, SPEED, and DMA registers[cite: 130].
2.  [cite_start]Registers that exist both in the FPI and MEGA II are SHADOWED during writes only[cite: 131]. [cite_start]Reads occur at FAST system speed[cite: 132]. [cite_start]These include SLOT, and STATE registers[cite: 133].

[cite_start]Finally, SHADOWING can be enabled either for ALL fast RAM banks, or just banks \$00 and \$01[cite: 134]. [cite_start]Most of the time, just banks \$00 and \$01 are SHADOWED[cite: 135].

***

### MEGA II INTERFACE

[cite_start]The slow and fast busses are connected via two buffers: one for the address signals and one for the data signals[cite: 137]. [cite_start]Each buffer has two inputs which control whether it is enabled at all, and if so, which direction to transfer the signals[cite: 138]. [cite_start]With the exception of DMA transfers, the address buffer is always enabled and configured to transfer from the fast to the slow side[cite: 139]. [cite_start]The data buffer is enabled on the second half of each slow cycle when PH0 is high[cite: 140]. [cite_start]The video scanner has control of the slow bus during the first half of each slow cycle when PH0 is low[cite: 141]. [cite_start]During a FAST cycle, the data buffer is always configured to transfer from the fast to the slow side[cite: 142]. [cite_start]During a SYNC cycle, the data buffer direction depends on whether the operation is a read or a write[cite: 143]. [cite_start]DMA transfers reverse the direction of this buffer, allowing peripheral cards access to fast RAM and ROM[cite: 144]. [cite_start]Both buffers drive the slow bus even during FAST cycles! [cite: 145] [cite_start]All circuitry on the slow bus must check the M2SEL signal to determine when a SYNC cycle is in progress[cite: 146]. [cite_start]The FPI asserts M2SEL during the portion of each SYNC cycle which overlaps a complete PH0 cycle[cite: 147].

***

### Diagrams

* **Page 5: System Architecture Diagram**
    * [cite_start]This page contains a block diagram illustrating the connections between major components like the CPU [cite: 152][cite_start], FPI [cite: 151][cite_start], ROM [cite: 153][cite_start], FAST RAM [cite: 154][cite_start], MEGA II [cite: 159][cite_start], VGC [cite: 162][cite_start], IWM [cite: 167][cite_start], SCC [cite: 168][cite_start], ADB [cite: 169][cite_start], SOUND GLU [cite: 172][cite_start], DOC [cite: 176][cite_start], and SLOTS[cite: 178]. [cite_start]It shows the various data and address busses (ABUS, DBUS, FRABUS, BABUS, MDBUS, etc.) that link them[cite: 149, 150, 156, 157, 158].

* **Page 6: Clock Generation Diagram**
    * This page features a diagram showing how various clock signals are generated and distributed. [cite_start]It shows the VGC [cite: 184] [cite_start]receiving a 28M clock and generating 14M [cite: 186] [cite_start]and STRETCH [cite: 185] signals. [cite_start]The 14M signal clocks the FPI [cite: 192] [cite_start]and MEGA2 [cite: 187] components. [cite_start]The FPI generates PH2 [cite: 193] [cite_start]for the CPU [cite: 194][cite_start], while the MEGA2 generates signals like PH0 [cite: 190] [cite_start]and Q3[cite: 189].

* **Page 7: PH2 Timing Diagram**
    * [cite_start]This page displays a timing diagram illustrating the relationships between the master 14M clock [cite: 204] [cite_start]and various PH2 clock cycles, including the standard PH2 [cite: 207][cite_start], PH2 REFRESH [cite: 208][cite_start], PH2 SYNC [cite: 209][cite_start], and PH2 SYNC STRETCH [cite: 210][cite_start], all relative to the slow bus clock PH0[cite: 205].

* **Pages 8-11: Additional Timing Diagrams**
    * These pages contain further timing diagrams detailing other signals, including:
        * [cite_start]Page 8: Signals related to the video and memory interface like RAS [cite: 214][cite_start], CAS [cite: 216][cite_start], Q3 [cite: 217][cite_start], and STRETCH[cite: 222].
        * [cite_start]Page 9: A list of video modes and memory regions such as TEXT 1 [cite: 225][cite_start], HGR 1 [cite: 227][cite_start], and SHR[cite: 230].
        * [cite_start]Page 10: FPI-related memory timing signals like LRAS [cite: 234] [cite_start]and LCAS [cite: 235] [cite_start]relative to 14M [cite: 232] [cite_start]and PH2[cite: 233].
        * [cite_start]Page 11: A depiction of the PH2 syncing process [cite: 239] [cite_start]relative to the 14M [cite: 236] [cite_start]and PH0 [cite: 237] clocks.
